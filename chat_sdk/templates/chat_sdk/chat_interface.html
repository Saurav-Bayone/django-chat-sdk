{% extends "base.html" %}
{% load chat_sdk_tags %}

{% block title %}Chat{% if conversation %} - {{ conversation.title }}{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .chat-container { display: flex; height: calc(100vh - 60px); overflow: hidden; }
  .chat-sidebar { width: 280px; border-right: 1px solid var(--phoenix-border-color); overflow-y: auto; }
  .chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 1.5rem; }
  .chat-input-area { border-top: 1px solid var(--phoenix-border-color); padding: 1rem 1.5rem; }
  .message-bubble { max-width: 85%; margin-bottom: 1rem; }
  .message-bubble.user-message { margin-left: auto; }
  .message-bubble.assistant-message { margin-right: auto; }
  .message-content { word-wrap: break-word; overflow-wrap: break-word; }
  .message-content pre { background: var(--phoenix-body-bg); border-radius: 0.375rem; padding: 0.75rem; overflow-x: auto; }
  .typing-indicator span { animation: blink 1.4s infinite both; }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
  .sidebar-item.active { background-color: var(--phoenix-primary-bg-subtle); }
  .tool-call-card { font-size: 0.85em; border-left: 3px solid var(--phoenix-info); }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
  <!-- Sidebar -->
  <div class="chat-sidebar d-none d-lg-block" id="chat-sidebar">
    {% include "chat_sdk/components/sidebar.html" %}
  </div>

  <!-- Main Chat Area -->
  <div class="chat-main">
    <!-- Header -->
    {% include "chat_sdk/components/chat_header.html" %}

    <!-- Messages -->
    <div class="chat-messages" id="chat-messages" data-simplebar>
      {% if conversation %}
        {% include "chat_sdk/components/message_list.html" %}
      {% else %}
        <div class="text-center text-body-tertiary mt-5">
          <div class="mb-3">
            <span data-feather="message-circle" style="width: 48px; height: 48px;"></span>
          </div>
          <h5>Start a new conversation</h5>
          <p class="text-body-secondary">Type a message below to begin</p>
        </div>
      {% endif %}
    </div>

    <!-- Streaming target -->
    <div id="streaming-message" class="px-4" style="display: none;"></div>

    <!-- Input Area -->
    {% include "chat_sdk/components/input_area.html" %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  'use strict';

  // --- State ---
  let ws = null;
  let conversationId = '{{ conversation.id|default:"" }}';
  let isStreaming = false;
  let currentStreamText = '';

  const messagesEl = document.getElementById('chat-messages');
  const streamingEl = document.getElementById('streaming-message');
  const inputEl = document.getElementById('chat-input');
  const sendBtn = document.getElementById('send-btn');
  const stopBtn = document.getElementById('stop-btn');

  // --- WebSocket Connection ---
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = conversationId
      ? `${protocol}//${window.location.host}/ws/chat-sdk/${conversationId}/`
      : `${protocol}//${window.location.host}/ws/chat-sdk/`;

    ws = new WebSocket(wsUrl);

    ws.onopen = function() {
      console.log('Chat SDK WebSocket connected');
    };

    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      handleServerMessage(data);
    };

    ws.onclose = function(event) {
      console.log('Chat SDK WebSocket closed:', event.code);
      if (event.code !== 4001) {
        setTimeout(connectWebSocket, 3000);
      }
    };

    ws.onerror = function(error) {
      console.error('Chat SDK WebSocket error:', error);
    };
  }

  // --- Message Handlers ---
  function handleServerMessage(data) {
    switch (data.type) {
      case 'connection_ready':
        break;

      case 'stream_start':
        isStreaming = true;
        currentStreamText = '';
        streamingEl.style.display = 'block';
        streamingEl.innerHTML = createAssistantBubble('');
        toggleButtons(true);
        scrollToBottom();
        break;

      case 'text_delta':
        currentStreamText += data.text;
        const contentEl = streamingEl.querySelector('.message-content');
        if (contentEl) {
          contentEl.textContent = currentStreamText;
        }
        scrollToBottom();
        break;

      case 'tool_call_start':
        appendToolCall(data.tool_call_id, data.tool_name);
        break;

      case 'tool_output':
        updateToolOutput(data.tool_call_id, data.output);
        break;

      case 'stream_end':
        isStreaming = false;
        // Move streaming content to message list
        if (currentStreamText || streamingEl.innerHTML) {
          const msgHtml = streamingEl.innerHTML;
          streamingEl.style.display = 'none';
          streamingEl.innerHTML = '';
          appendToMessages(msgHtml);
        }
        toggleButtons(false);
        scrollToBottom();
        break;

      case 'error':
        isStreaming = false;
        streamingEl.style.display = 'none';
        toggleButtons(false);
        showError(data.message);
        break;

      case 'conversation_updated':
        conversationId = data.conversation_id;
        // Update sidebar
        const sidebarEl = document.getElementById('chat-sidebar');
        if (sidebarEl) {
          htmx.ajax('GET', '/chat-sdk/htmx/sidebar/', {target: '#chat-sidebar', swap: 'innerHTML'});
        }
        // Update URL without reload
        window.history.replaceState({}, '', `/chat-sdk/c/${data.conversation_id}/`);
        break;

      case 'conversations':
        // Handle conversation list update
        break;
    }
  }

  // --- UI Helpers ---
  function createAssistantBubble(text) {
    return `
      <div class="message-bubble assistant-message">
        <div class="d-flex align-items-start gap-2">
          <div class="avatar avatar-s rounded-circle bg-body-tertiary d-flex align-items-center justify-content-center flex-shrink-0">
            <span data-feather="cpu" class="text-primary" style="width:16px;height:16px;"></span>
          </div>
          <div class="card shadow-none border">
            <div class="card-body py-2 px-3">
              <div class="message-content">${escapeHtml(text)}</div>
              <div class="typing-indicator" id="typing-dots">
                <span class="text-body-tertiary">&#x25cf;</span>
                <span class="text-body-tertiary">&#x25cf;</span>
                <span class="text-body-tertiary">&#x25cf;</span>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }

  function appendToolCall(toolCallId, toolName) {
    const html = `
      <div class="tool-call-card card shadow-none border mt-2 mb-2" id="tool-${toolCallId}">
        <div class="card-body py-2 px-3">
          <div class="d-flex align-items-center gap-2">
            <span data-feather="tool" style="width:14px;height:14px;" class="text-info"></span>
            <small class="fw-semibold text-info">${escapeHtml(toolName)}</small>
            <div class="spinner-border spinner-border-sm text-info" role="status"></div>
          </div>
          <div class="tool-output mt-1" style="display:none;"></div>
        </div>
      </div>`;
    streamingEl.insertAdjacentHTML('beforeend', html);
    if (window.feather) feather.replace();
  }

  function updateToolOutput(toolCallId, output) {
    const el = document.getElementById(`tool-${toolCallId}`);
    if (el) {
      const spinner = el.querySelector('.spinner-border');
      if (spinner) spinner.remove();
      const outputEl = el.querySelector('.tool-output');
      if (outputEl) {
        outputEl.style.display = 'block';
        outputEl.innerHTML = `<pre class="mb-0 small">${escapeHtml(JSON.stringify(output, null, 2))}</pre>`;
      }
    }
  }

  function sendMessage() {
    const text = inputEl.value.trim();
    if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

    // Show user message
    appendUserMessage(text);
    inputEl.value = '';
    autoResize();

    // Send via WebSocket
    ws.send(JSON.stringify({
      type: 'chat_message',
      text: text,
      conversation_id: conversationId || null,
      model_id: document.getElementById('model-select')?.value || null,
    }));
  }

  function appendUserMessage(text) {
    const html = `
      <div class="message-bubble user-message">
        <div class="d-flex align-items-start gap-2 justify-content-end">
          <div class="card shadow-none bg-primary-subtle border-0">
            <div class="card-body py-2 px-3">
              <div class="message-content text-primary">${escapeHtml(text)}</div>
            </div>
          </div>
          <div class="avatar avatar-s rounded-circle bg-primary d-flex align-items-center justify-content-center flex-shrink-0">
            <span data-feather="user" class="text-white" style="width:16px;height:16px;"></span>
          </div>
        </div>
      </div>`;
    appendToMessages(html);
    scrollToBottom();
  }

  function appendToMessages(html) {
    const wrapper = messagesEl.querySelector('.simplebar-content') || messagesEl;
    wrapper.insertAdjacentHTML('beforeend', html);
    if (window.feather) feather.replace();
  }

  function scrollToBottom() {
    const scrollEl = messagesEl.querySelector('.simplebar-content-wrapper') || messagesEl;
    scrollEl.scrollTop = scrollEl.scrollHeight;
  }

  function toggleButtons(streaming) {
    if (sendBtn) sendBtn.style.display = streaming ? 'none' : '';
    if (stopBtn) stopBtn.style.display = streaming ? '' : 'none';
  }

  function showError(message) {
    const html = `
      <div class="alert alert-danger alert-dismissible fade show mx-3" role="alert">
        <span data-feather="alert-circle" class="me-2" style="width:16px;height:16px;"></span>
        ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
    appendToMessages(html);
    if (window.feather) feather.replace();
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function autoResize() {
    if (inputEl) {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
    }
  }

  // --- Event Listeners ---
  if (inputEl) {
    inputEl.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    inputEl.addEventListener('input', autoResize);
  }

  if (sendBtn) {
    sendBtn.addEventListener('click', sendMessage);
  }

  if (stopBtn) {
    stopBtn.addEventListener('click', function() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({type: 'stop'}));
      }
    });
  }

  // --- Initialize ---
  connectWebSocket();

  // Listen for new conversation events from HTMX
  document.body.addEventListener('conversationCreated', function(e) {
    conversationId = e.detail.id;
    if (ws) ws.close();
    connectWebSocket();
  });
})();
</script>
{% endblock %}
